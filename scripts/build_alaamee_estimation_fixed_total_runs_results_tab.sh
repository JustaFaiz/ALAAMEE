#!/bin/sh
#
# File:    build_alaamee_estimation_fixed_total_runs_results_tab.sh
# Author:  Alex Stivala
# Created: August 2024
#
# Build table for reading into R of results of ALAAMEE estimation,
# with specified number of total runs (instead of all
# runs present in the job output).
# 
# Usage: build_alaamee_estimation_fixed_total_runs_results_tab.sh totalruns joboutputroot
#
# E.g.:
#   /build_alaamee_estimation_fixed_total_runs_results_tab.sh 200 /scratch/stivala/ALAAMEE_estimations_simulated_Project90/simulated_Project90
#
# Output is to stdout
#
# Uses various GNU utils options on echo, etc.


module load gcc/11.3.0 # needed by r/4.2.1
module load openmpi/4.1.4 # needed by r/4.2.1
module load r/4.2.1

SCRIPTDIR=`dirname $0`
RSCRIPTDIR=${SCRIPTDIR}/../R

if [ $# -ne 2 ]; then
    echo "usage: $0 totalruns joboutputrootdir" >&2
    exit 1
fi

totalRuns=$1
joboutputroot=$2

tmpfile=`mktemp` || exit 1

echo "# Generated by: $0 $*"
echo "# At: " `date`
echo "# On: " `uname -a`
echo -e "Effect\tEstimate\tsdEstimate\tStdErr\tt-ratio\tsampleId\tnodeCount\tconvergedRuns\ttotalRuns"
for sampledir in ${joboutputroot}/sample*
do
    Rscript ${RSCRIPTDIR}/computeALAMEEcovariance.R --max_runs=${totalRuns} ${sampledir}/theta_values_project90_giantcomponent ${sampledir}/dzA_values_project90_giantcomponent > ${tmpfile}
    if [ $? -ne 0 ]; then
      echo "ERROR: computeALAAMEEcovariance.R failed in ${sampledir}" >&2
      exit 1
    fi
    sampleid=`basename "${sampledir}" | sed 's/sample//g'`
    nodecount=`wc -l ${sampledir}/sample-*sim${sampleid}.txt | awk '{print $1}'`
    nodecount=`expr ${nodecount} - 1`  # less 1 for header line
    totalruns=`fgrep -w TotalRuns ${tmpfile} | awk '{print $2}'`
    convergedruns=`fgrep -w ConvergedRuns ${tmpfile} | awk '{print $2}'`
    # also convert effect names into same as used in Snowball PNet 
    # https://unix.stackexchange.com/questions/78472/print-lines-between-start-and-end-using-sed
    cat ${tmpfile} | sed -n -e '/^Pooled/,/^TotalRuns/{//!p}' | tr -d '*' | fgrep -vw AcceptanceRate | fgrep -vw TotalRuns | fgrep -vw ConvergedRuns  |  sed 's/AltInStars/AinS/;s/AltOutStars/AoutS/;s/AltKTrianglesT/AKT-T/;s/AltTwoPathsTD/A2P-TD/;s/Sender_binaryAttribute/Sender/;s/Receiver_binaryAttribute/Receiver/;s/Interaction_binaryAttribute/Interaction/;s/Matching_categoricalAttribute/Matching/;s/MatchingReciprocity_categoricalAttribute/MatchingReciprocity/' | tr ' ' '\t' | sed "s/\$/\t${sampleid}\t${nodecount}\t${convergedruns}\t${totalruns}/"
done
rm ${tmpfile}
